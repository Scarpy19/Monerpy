---
import Layout from "@layouts/Layout.astro";
import LogoutScript from "@comps/layout/LogoutScript.astro";
import Header from "@comps/layout/Header.astro";
import RecurringTransactionModal from "@comps/modal/RecurringTransactionModal.astro";
import ToastScript from "@comps/toast/ToastScript.astro";
import { actions } from "astro:actions";
import { formatDateForDisplay, formatCurrency } from "@lib/date-utils.ts";
import JoinFamily from "@comps/layout/JoinFamily.astro";
import CreateAccount from "@comps/layout/CreateAccount.astro";
import TransactionIcon from "@comps/svgs/mono/TransactionIcon.astro";
import Loop from "@comps/svgs/mono/Loop.astro";
import { RECURRING_STATUS_COLORS, RECURRING_TEXT_COLORS } from "@arrays.d.ts";
import PlusButton from "@/components/PlusButton.astro";

const user = Astro.locals.user;

if (!user) {
    return Astro.redirect("/login");
}

// Handle form submissions
let toastMessage = "";
let toastType = "success";

if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const action = formData.get("_action") as string;

    if (action === "create") {
        const result = await Astro.callAction(
            actions.createRecurringTransaction,
            formData,
        );
        console.log("Create recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction created successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction creation failed:",
                result.error || result.data?.error,
            );
            toastMessage =
                "Failed to create recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "update") {
        const result = await Astro.callAction(
            actions.updateRecurringTransaction,
            formData,
        );
        console.log("Update recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction updated successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction update failed:",
                result.error || result.data?.error,
            );
            toastMessage =
                "Failed to update recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "delete") {
        const result = await Astro.callAction(
            actions.deleteRecurringTransaction,
            formData,
        );
        console.log("Delete recurring transaction result:", result);
        if (result.data?.ok) {
            toastMessage = "Recurring transaction deleted successfully!";
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction deletion failed:",
                result.error || result.data?.error,
            );
            toastMessage =
                "Failed to delete recurring transaction. Please try again.";
            toastType = "error";
        }
    } else if (action === "generate") {
        const result = await Astro.callAction(
            actions.generateRecurringTransactions,
            formData,
        );
        console.log("Generate recurring transactions result:", result);
        if (result.data?.ok) {
            const generated = result.data.generated || 0;
            toastMessage = `Generated ${generated} transaction${generated !== 1 ? "s" : ""} successfully!`;
            toastType = "success";
        } else {
            console.error(
                "Recurring transaction generation failed:",
                result.error || result.data?.error,
            );
            toastMessage = "Failed to generate transactions. Please try again.";
            toastType = "error";
        }
    }
}

// Check if user is in a family first
const userResult = await Astro.callAction(actions.getFamilyDetails, {});
const userInFamily = userResult.data?.ok && userResult.data.family;

// Get accounts data only if user is in a family
const accountsResult = userInFamily
    ? await Astro.callAction(actions.getAccountsList, { includeDeleted: false })
    : { data: { ok: false, accounts: [] } };
const accounts = accountsResult.data?.ok ? accountsResult.data.accounts : [];

// Get data for the page only if user has accounts
const recurringTransactionsResult =
    userInFamily && accounts && accounts.length > 0
        ? await Astro.callAction(actions.getRecurringTransactions, {
              page: 1,
              limit: 20,
          })
        : { data: { ok: false, recurringTransactions: [], pagination: null } };

const recurringTransactions = recurringTransactionsResult.data?.ok
    ? recurringTransactionsResult.data.recurringTransactions
    : [];
const pagination = recurringTransactionsResult.data?.ok
    ? recurringTransactionsResult.data.pagination
    : null;

// Calculate next execution dates for active recurring transactions
const recurringTransactionsWithNextDates = (recurringTransactions ?? []).map(
    (rt) => {
        if (rt.status !== "active") {
            return { ...rt, nextExecution: null, upcomingDates: [] };
        }

        const now = new Date();
        const startDate = new Date(rt.startDate);
        let nextDate = new Date(Math.max(startDate.getTime(), now.getTime()));

        // Calculate next execution date based on frequency
        const upcomingDates: Date[] = [];
        let tempDate = new Date(nextDate);

        for (let i = 0; i < 5; i++) {
            // Check end conditions
            const endDate = rt.endDate ? new Date(rt.endDate) : null;
            if (endDate && tempDate > endDate) break;
            if (
                rt.maxOccurrences &&
                rt.occurrencesCount + i >= rt.maxOccurrences
            )
                break;

            switch (rt.frequency) {
                case "Daily":
                    tempDate = new Date(tempDate);
                    tempDate.setDate(tempDate.getDate() + (i === 0 ? 0 : 1));
                    break;
                case "Weekly":
                    if (i === 0) {
                        // Find next occurrence of the specified day of week
                        const currentDayOfWeek = tempDate.getDay();
                        const targetDayOfWeek = rt.dayOfWeek || 0;
                        const daysUntilNext =
                            (targetDayOfWeek - currentDayOfWeek + 7) % 7;
                        tempDate.setDate(
                            tempDate.getDate() +
                                (daysUntilNext === 0 ? 7 : daysUntilNext),
                        );
                    } else {
                        tempDate.setDate(tempDate.getDate() + 7);
                    }
                    break;
                case "Monthly":
                    if (i === 0) {
                        tempDate.setDate(rt.dayOfMonth || 1);
                        if (tempDate <= now) {
                            tempDate.setMonth(tempDate.getMonth() + 1);
                        }
                    } else {
                        tempDate.setMonth(tempDate.getMonth() + 1);
                    }
                    break;
                case "Yearly":
                    if (i === 0) {
                        tempDate.setMonth(0); // January
                        tempDate.setDate(rt.dayOfMonth || 1);
                        if (tempDate <= now) {
                            tempDate.setFullYear(tempDate.getFullYear() + 1);
                        }
                    } else {
                        tempDate.setFullYear(tempDate.getFullYear() + 1);
                    }
                    break;
            }

            upcomingDates.push(new Date(tempDate));
        }

        return {
            ...rt,
            nextExecution: upcomingDates[0] || null,
            upcomingDates,
        };
    },
);

// Helper function to get status color
function getStatusColor(status: string): string {
    return RECURRING_STATUS_COLORS[status] || "text-gray-400";
}

// Helper function to get status text
function getStatusText(status: string): string {
    return RECURRING_TEXT_COLORS[status] || "Unknown";
}
---

<Layout
    title="Recurring Transactions"
    description="Manage your recurring transactions"
>
    <main class="bg-gray-900 p-8 text-white">
        <Header currentPage="recurring" user={user} />

        {
            !userInFamily ? (
                <JoinFamily />
            ) : !accounts || accounts.length === 0 ? (
                <CreateAccount />
            ) : (
                <div class="bg-gray-800 shadow-lg px-6 py-6 rounded-lg mx-auto max-w-7xl">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-baseline-last gap-4">
                            <h2 class="font-semibold text-purple-400 text-xl flex items-center gap-2">
                                <Loop />
                                Recurring
                            </h2>
                            <a
                                href="/transactions"
                                class="text-purple-400 hover:text-purple-300 flex items-center gap-2"
                            >
                                <TransactionIcon class="w-4 h-4" />
                                <span>Transactions</span>
                            </a>
                        </div>
                        <div class="flex items-center gap-4">
                            <button
                                type="button"
                                id="generateAllBtn"
                                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white transition duration-200 text-sm"
                                title="Generate all pending transactions up to today"
                            >
                                Generate All Pending (WIP)
                            </button>

                            <PlusButton
                                id="addRecurringTransactionBtn"
                                title="Add a new Recurring Transaction"
                            />
                        </div>
                    </div>

                    {!recurringTransactions ||
                    recurringTransactions.length === 0 ? (
                        <div class="text-center py-10 text-gray-400">
                            <p class="text-lg mb-2">
                                No recurring transactions found
                            </p>
                            <p class="text-sm">
                                Add your first recurring transaction to automate
                                your finances!
                            </p>
                        </div>
                    ) : (
                        <div class="flex flex-col gap-y-6">
                            {recurringTransactionsWithNextDates.map(
                                (recurringTransaction) => (
                                    <div class="bg-gray-700 rounded-lg p-6 hover:bg-gray-650 transition-all duration-200 hover:shadow-md border border-gray-600 hover:border-gray-500">
                                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                                            <div class="lg:col-span-5">
                                                <div class="flex items-start justify-between mb-3">
                                                    <div class="flex-1">
                                                        <h3 class="font-semibold text-white text-lg leading-tight">
                                                            {
                                                                recurringTransaction.description
                                                            }
                                                        </h3>
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <span class="text-sm text-gray-400">
                                                                {
                                                                    recurringTransaction
                                                                        .account
                                                                        .name
                                                                }
                                                            </span>
                                                            <div
                                                                class="w-2 h-2 rounded-full"
                                                                style={`background-color: ${recurringTransaction.account.color}`}
                                                            />
                                                            <span class="text-xs text-gray-500">
                                                                {
                                                                    recurringTransaction.frequency
                                                                }
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div
                                                        class={`text-sm font-medium ${getStatusColor(recurringTransaction.status)}`}
                                                    >
                                                        {getStatusText(
                                                            recurringTransaction.status,
                                                        )}
                                                    </div>
                                                </div>

                                                <div class="flex items-center gap-2 flex-wrap mb-3">
                                                    {recurringTransaction.category && (
                                                        <span
                                                            class="px-2 py-1 rounded-full text-xs font-medium text-white"
                                                            style={`background-color: ${recurringTransaction.category.color}`}
                                                        >
                                                            {
                                                                recurringTransaction
                                                                    .category
                                                                    .name
                                                            }
                                                        </span>
                                                    )}
                                                    {recurringTransaction.tags.map(
                                                        (tag) => (
                                                            <span
                                                                class="text-xs px-2 py-1 rounded-full text-white border"
                                                                style={`background-color: ${tag.color}; border-color: ${tag.color}`}
                                                            >
                                                                {tag.name}
                                                            </span>
                                                        ),
                                                    )}
                                                </div>

                                                <div
                                                    class={`text-xl font-bold ${
                                                        recurringTransaction.type ===
                                                        "Income"
                                                            ? "text-green-400"
                                                            : "text-red-400"
                                                    }`}
                                                >
                                                    {recurringTransaction.type ===
                                                    "Income"
                                                        ? "+"
                                                        : "-"}
                                                    {formatCurrency(
                                                        recurringTransaction.amount,
                                                    )}
                                                </div>
                                            </div>

                                            <div class="lg:col-span-4">
                                                <div class="text-sm text-gray-300 flex flex-col gap-y-1">
                                                    <div>
                                                        <span class="text-gray-400">
                                                            Started:
                                                        </span>
                                                        {formatDateForDisplay(
                                                            recurringTransaction.startDate,
                                                            {
                                                                includeTime: false,
                                                            },
                                                        )}
                                                    </div>
                                                    {recurringTransaction.endDate && (
                                                        <div>
                                                            <span class="text-gray-400">
                                                                Ends:
                                                            </span>
                                                            {formatDateForDisplay(
                                                                recurringTransaction.endDate,
                                                                {
                                                                    includeTime: false,
                                                                },
                                                            )}
                                                        </div>
                                                    )}
                                                    {recurringTransaction.maxOccurrences && (
                                                        <div>
                                                            <span class="text-gray-400">
                                                                Occurrences:
                                                            </span>
                                                            {
                                                                recurringTransaction.occurrencesCount
                                                            }
                                                            {" / "}
                                                            {
                                                                recurringTransaction.maxOccurrences
                                                            }
                                                            {recurringTransaction.remainingOccurrences !==
                                                                null && (
                                                                <span class="text-yellow-400 ml-1">
                                                                    (
                                                                    {
                                                                        recurringTransaction.remainingOccurrences
                                                                    }
                                                                    left)
                                                                </span>
                                                            )}
                                                        </div>
                                                    )}
                                                    <div>
                                                        <span class="text-gray-400">
                                                            Time:
                                                        </span>
                                                        {
                                                            recurringTransaction.timeOfDay
                                                        }
                                                    </div>
                                                </div>

                                                {recurringTransaction.nextExecution && (
                                                    <div class="mt-3 p-2 bg-gray-600 rounded">
                                                        <div class="text-xs text-gray-400">
                                                            Next:
                                                        </div>
                                                        <div class="text-sm text-yellow-400 font-medium">
                                                            {formatDateForDisplay(
                                                                recurringTransaction.nextExecution
                                                                    .toISOString()
                                                                    .replace(
                                                                        "T",
                                                                        " ",
                                                                    )
                                                                    .split(
                                                                        ".",
                                                                    )[0],
                                                                {
                                                                    includeTime: false,
                                                                },
                                                            )}
                                                        </div>
                                                    </div>
                                                )}

                                                {recurringTransaction.upcomingDates &&
                                                    recurringTransaction
                                                        .upcomingDates.length >
                                                        1 && (
                                                        <div class="mt-2">
                                                            <div class="text-xs text-gray-400 mb-1">
                                                                Upcoming:
                                                            </div>
                                                            <div class="flex flex-wrap gap-1">
                                                                {recurringTransaction.upcomingDates
                                                                    .slice(1, 4)
                                                                    .map(
                                                                        (
                                                                            date,
                                                                        ) => (
                                                                            <span class="text-xs bg-gray-600 px-2 py-1 rounded text-gray-300">
                                                                                {date.toLocaleDateString(
                                                                                    "es-ES",
                                                                                    {
                                                                                        month: "short",
                                                                                        day: "numeric",
                                                                                    },
                                                                                )}
                                                                            </span>
                                                                        ),
                                                                    )}
                                                            </div>
                                                        </div>
                                                    )}
                                            </div>

                                            <div class="lg:col-span-3 flex lg:flex-col flex-row gap-2 lg:items-end">
                                                <button
                                                    type="button"
                                                    class="edit-btn bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                    data-recurring-transaction={JSON.stringify(
                                                        recurringTransaction,
                                                    )}
                                                    title="Edit recurring transaction"
                                                >
                                                    Edit
                                                </button>

                                                {recurringTransaction.status ===
                                                    "active" && (
                                                    <button
                                                        type="button"
                                                        class="generate-btn bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                        data-id={
                                                            recurringTransaction.id
                                                        }
                                                        title="Generate pending transactions"
                                                    >
                                                        Generate
                                                    </button>
                                                )}

                                                <form
                                                    method="POST"
                                                    class="inline"
                                                >
                                                    <input
                                                        type="hidden"
                                                        name="_action"
                                                        value="delete"
                                                    />
                                                    <input
                                                        type="hidden"
                                                        name="id"
                                                        value={
                                                            recurringTransaction.id
                                                        }
                                                    />
                                                    <button
                                                        type="submit"
                                                        class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-white transition duration-200 text-sm"
                                                        title="Delete recurring transaction"
                                                        onclick="return confirm('Are you sure you want to delete this recurring transaction? This will not affect already generated transactions.')"
                                                    >
                                                        Delete
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        {recurringTransaction.logs &&
                                            recurringTransaction.logs.length >
                                                0 && (
                                                <div class="mt-4 pt-4 border-t border-gray-600">
                                                    <div class="text-sm text-gray-400 mb-2">
                                                        Recent Generated
                                                        Transactions:
                                                    </div>
                                                    <div class="flex flex-wrap gap-2">
                                                        {recurringTransaction.logs
                                                            .slice(0, 3)
                                                            .map((log) => (
                                                                <div class="text-xs bg-gray-600 px-2 py-1 rounded">
                                                                    {formatDateForDisplay(
                                                                        log.executionTime,
                                                                        {
                                                                            includeTime: false,
                                                                        },
                                                                    )}
                                                                    {log.generatedTransaction && (
                                                                        <span class="text-green-400 ml-1">
                                                                            ✓
                                                                            {formatCurrency(
                                                                                log
                                                                                    .generatedTransaction
                                                                                    .amount,
                                                                            )}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        {recurringTransaction
                                                            .logs.length >
                                                            3 && (
                                                            <div class="text-xs text-gray-400 px-2 py-1">
                                                                +
                                                                {recurringTransaction
                                                                    .logs
                                                                    .length - 3}
                                                                more
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                    </div>
                                ),
                            )}
                        </div>
                    )}

                    {pagination && pagination.totalPages > 1 && (
                        <div class="flex justify-center mt-6 gap-2">
                            {Array.from(
                                { length: pagination.totalPages },
                                (_, i) => (
                                    <a
                                        href={`/recurring?page=${i + 1}`}
                                        class={`px-3 py-2 rounded ${
                                            pagination.page === i + 1
                                                ? "bg-purple-600 text-white"
                                                : "bg-gray-700 text-gray-300 hover:bg-gray-600"
                                        }`}
                                    >
                                        {i + 1}
                                    </a>
                                ),
                            )}
                        </div>
                    )}
                </div>
            )
        }
    </main>

    <RecurringTransactionModal />
    {toastMessage && <ToastScript message={toastMessage} type={toastType} />}

    <LogoutScript />

    <script>
        // Add Recurring Transaction button functionality
        const addRecurringTransactionBtn = document.getElementById(
            "addRecurringTransactionBtn",
        ) as HTMLButtonElement;
        if (addRecurringTransactionBtn) {
            addRecurringTransactionBtn.addEventListener("click", function () {
                const openModal = (window as any).openRecurringTransactionModal;
                if (openModal) {
                    openModal();
                }
            });
        }

        // Edit functionality
        document.querySelectorAll(".edit-btn").forEach((btn) => {
            btn.addEventListener("click", function (this: HTMLElement) {
                const recurringTransactionData =
                    this.dataset.recurringTransaction;
                if (!recurringTransactionData) return;

                const recurringTransaction = JSON.parse(
                    recurringTransactionData,
                );
                const fillFormForEdit = (window as any)
                    .fillRecurringFormForEdit;
                if (fillFormForEdit) {
                    fillFormForEdit(recurringTransaction);
                }
            });
        });

        // Generate functionality
        document.querySelectorAll(".generate-btn").forEach((btn) => {
            btn.addEventListener("click", function (this: HTMLElement) {
                const id = this.dataset.id;
                if (!id) return;

                if (
                    confirm(
                        "Generate pending transactions for this recurring rule up to today?",
                    )
                ) {
                    const form = document.createElement("form");
                    form.method = "POST";
                    form.innerHTML = `
                    <input type="hidden" name="_action" value="generate">
                    <input type="hidden" name="recurringTransactionIds" value="${id}">
                    <input type="hidden" name="generateUpTo" value="today">
                `;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });

        // Generate All functionality
        const generateAllBtn = document.getElementById("generateAllBtn");
        if (generateAllBtn) {
            generateAllBtn.addEventListener("click", function () {
                const activeIds = Array.from(
                    document.querySelectorAll(".generate-btn"),
                )
                    .map((btn) => (btn as HTMLElement).dataset.id)
                    .filter((id) => id);

                if (activeIds.length === 0) {
                    alert("No active recurring transactions found.");
                    return;
                }

                if (
                    confirm(
                        `Generate all pending transactions for ${activeIds.length} recurring rule${activeIds.length !== 1 ? "s" : ""} up to today?`,
                    )
                ) {
                    const form = document.createElement("form");
                    form.method = "POST";
                    form.innerHTML = `
                    <input type="hidden" name="_action" value="generate">
                    <input type="hidden" name="recurringTransactionIds" value="${activeIds.join(",")}">
                    <input type="hidden" name="generateUpTo" value="today">
                `;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        addRecurringTransactionBtn.click();
    </script>
</Layout>
