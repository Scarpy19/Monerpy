---
import X from "@svg/mono/X.astro";
import ColorPicker from "@comps/ColorPicker.astro";
import Input from "@comps/Input.astro";
import { accountTypes } from "@arrays.d.ts";
---

<!-- Modal as a Custom Element host -->
<account-modal
    id="accountModal"
    class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center h-screen"
>
    <div
        class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto"
    >
        <!-- Modal Header -->
        <header
            class="flex items-end justify-between py-4.5 px-6 border-b border-gray-700"
        >
            <h2 class="text-xl font-semibold text-purple-400">
                Create Account
            </h2>
            <button
                type="button"
                id="closeModal"
                class="text-gray-400 hover:text-white transition-colors"
            >
                <X class="w-6 h-6" />
            </button>
        </header>

        <!-- Modal Content -->
        <form method="POST" class="p-6 flex flex-col gap-y-4">
            <input type="hidden" name="_action" value="create" />

            <Input
                id="accountName"
                label="Account Name"
                name="name"
                required
                placeholder="Enter account name"
            />

            <label for="accountType">
                <p class="text-sm font-medium text-gray-200 mb-2">
                    Account Type *
                </p>
                <select
                    id="accountType"
                    name="accountType"
                    required
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
                    <option value="">Select account type</option>
                    {
                        accountTypes.map((type) => (
                            <option value={type.value}>
                                {type.icon} {type.label}
                            </option>
                        ))
                    }
                </select>
            </label>

            <label for="initialBalance">
                <p class="text-sm font-medium text-gray-200 mb-2">
                    Initial Balance
                </p>
                <input
                    type="number"
                    id="initialBalance"
                    name="initialBalance"
                    step="0.01"
                    value="0.00"
                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="0.00"
                />
            </label>

            <ColorPicker id="color" label="Account Color" />

            <div class="flex items-center justify-end gap-x-3 pt-4">
                <button
                    type="button"
                    id="cancelAccountButton"
                    class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-white transition duration-200"
                    >Cancel</button
                >
                <button
                    type="submit"
                    class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded transition-colors"
                    >Create Account</button
                >
            </div>
        </form>
    </div>
</account-modal>

<script type="module" is:inline>
    // Define a small custom element that manages its own inner markup (light DOM)
    class AccountModal extends HTMLElement {
        constructor() {
            super();
            this._onCloseClick = this._onCloseClick.bind(this);
            this._onCancelClick = this._onCancelClick.bind(this);
            this._onMouseDown = this._onMouseDown.bind(this);
            this._onMouseUp = this._onMouseUp.bind(this);
            this._downOutside = false;
        }

        connectedCallback() {
            // use the element itself as the modal root
            this.root = this;

            this._closeBtn = this.root.querySelector("#closeModal");
            this._cancelBtn = this.root.querySelector("#cancelAccountButton");

            if (this._closeBtn)
                this._closeBtn.addEventListener("click", this._onCloseClick);
            if (this._cancelBtn)
                this._cancelBtn.addEventListener("click", this._onCancelClick);

            // background click handling on host
            this.addEventListener("mousedown", this._onMouseDown);
            this.addEventListener("mouseup", this._onMouseUp);
        }

        disconnectedCallback() {
            if (this._closeBtn)
                this._closeBtn.removeEventListener("click", this._onCloseClick);
            if (this._cancelBtn)
                this._cancelBtn.removeEventListener(
                    "click",
                    this._onCancelClick,
                );
            this.removeEventListener("mousedown", this._onMouseDown);
            this.removeEventListener("mouseup", this._onMouseUp);
        }

        _onCloseClick() {
            this.closeModal();
        }
        _onCancelClick() {
            this.closeModal();
        }

        _onMouseDown(e) {
            if (e.target === this && e.button === 0) this._downOutside = true;
            else this._downOutside = false;
        }

        _onMouseUp(e) {
            if (this._downOutside && e.target === this && e.button === 0)
                this.closeModal();
            this._downOutside = false;
        }

        openModal() {
            this.classList.remove("hidden");
            this.classList.add("flex");
            document.body.style.overflow = "hidden";
        }

        closeModal() {
            this.classList.add("hidden");
            this.classList.remove("flex");
            document.body.style.overflow = "auto";
            // reset form inside
            const form = this.querySelector("form");
            if (form) form.reset();
            // reset first color radio if present
            const firstColor = form
                ? form.querySelector('input[name="color"]')
                : null;
            if (firstColor) firstColor.checked = true;
        }
    }

    if (!customElements.get("account-modal")) {
        customElements.define("account-modal", AccountModal);
    }
</script>
